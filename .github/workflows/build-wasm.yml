name: Build QPDF Libraries for WASM

on:
    workflow_dispatch:
    push:
        branches: [wasm]

env:
    QPDF_VERSION: "12.2.0"
    LIBJPEG_TURBO_VERSION: "3.1.3"
    CMAKE_COMMON_FLAGS: "-DREQUIRE_CRYPTO_NATIVE=ON -DUSE_IMPLICIT_CRYPTO=0 -DCI_MODE=1 -DBUILD_DOC=OFF -DINSTALL_EXAMPLES=OFF"

jobs:
    # ============================================================================
    # WASM Builds
    # ============================================================================
    build-wasm:
        name: WASM
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Emscripten
              uses: mymindstorm/setup-emsdk@v14
              with:
                  version: 3.1.51

            - name: Clone Sources
              run: |
                  git clone --depth 1 --branch v${{ env.QPDF_VERSION }} https://github.com/qpdf/qpdf.git qpdf-src
                  git clone --depth 1 --branch ${{ env.LIBJPEG_TURBO_VERSION }} https://github.com/libjpeg-turbo/libjpeg-turbo.git libjpeg-turbo-src
                  git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git zlib-src

            - name: Build zlib (static)
              run: |
                  cd zlib-src
                  emconfigure ./configure --prefix=${{ github.workspace }}/wasm-deps --static
                  emmake make -j$(nproc) install

            - name: Build libjpeg-turbo (static)
              run: |
                  cd libjpeg-turbo-src
                  mkdir build && cd build
                  emcmake cmake .. \
                    -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/wasm-deps \
                    -DENABLE_SHARED=OFF \
                    -DENABLE_STATIC=ON \
                    -DWITH_SIMD=0 \
                    -DWITH_TURBOJPEG=OFF \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_C_FLAGS="-Oz -flto"
                  emmake make -j$(nproc) install

            - name: Build QPDF (static library)
              run: |
                  cd qpdf-src
                  mkdir build && cd build
                  emcmake cmake -S .. -B . \
                    -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/wasm-deps \
                    -DCMAKE_PREFIX_PATH=${{ github.workspace }}/wasm-deps \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DBUILD_SHARED_LIBS=OFF \
                    -DBUILD_STATIC_LIBS=ON \
                    -DRANDOM_DEVICE=/dev/urandom \
                    -DCMAKE_CXX_FLAGS="-Oz -flto" \
                    ${{ env.CMAKE_COMMON_FLAGS }}
                  cmake --build . --parallel $(nproc) --target libqpdf

            - name: Link WASM module
              run: |
                  WASM_OUT=${{ github.workspace }}/wasm-out
                  mkdir -p $WASM_OUT

                  emcc \
                    -Oz -flto \
                    --closure 1 \
                    -I${{ github.workspace }}/wasm-deps/include \
                    -I${{ github.workspace }}/qpdf-src/include \
                    -L${{ github.workspace }}/wasm-deps/lib \
                    ${{ github.workspace }}/wasm/qpdf_wasm.c \
                    ${{ github.workspace }}/qpdf-src/build/libqpdf/libqpdf.a \
                    ${{ github.workspace }}/qpdf-src/qpdf/qpdf.cc \
                    -ljpeg -lz \
                    -sALLOW_MEMORY_GROWTH=1 \
                    -sINITIAL_MEMORY=67108864 \
                    -sSTACK_SIZE=1MB \
                    -sMODULARIZE=1 \
                    -sEXPORT_ES6=1 \
                    -sEXPORT_NAME=createQpdfModule \
                    -sEXPORTED_RUNTIME_METHODS=["callMain","FS","cwrap","ccall"] \
                    -sEXPORTED_FUNCTIONS=["_main","_malloc","_free"] \
                    -sNO_DISABLE_EXCEPTION_CATCHING=1 \
                    -sENVIRONMENT=web,worker,node \
                    -sDYNAMIC_EXECUTION=0 \
                    -o $WASM_OUT/qpdf_wasm.js

                  # Copy the JS wrapper
                  cp ${{ github.workspace }}/wasm/qpdf.mjs $WASM_OUT/qpdf.mjs

                  echo "=== WASM output ==="
                  ls -lh $WASM_OUT/

            - name: Collect Artifacts
              run: |
                  mkdir -p artifacts/wasm
                  cp ${{ github.workspace }}/wasm-out/qpdf_wasm.js artifacts/wasm/
                  cp ${{ github.workspace }}/wasm-out/qpdf_wasm.wasm artifacts/wasm/
                  cp ${{ github.workspace }}/wasm-out/qpdf.mjs artifacts/wasm/
                  tar -cvf artifacts/wasm.tar -C artifacts wasm

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: qpdf-wasm
                  path: artifacts/wasm.tar
