name: Build QPDF Libraries

on:
    workflow_dispatch:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    QPDF_VERSION: "12.2.0"
    LIBJPEG_TURBO_VERSION: "3.1.3"
    CMAKE_COMMON_FLAGS: "-DREQUIRE_CRYPTO_NATIVE=ON -DUSE_IMPLICIT_CRYPTO=0 -DCI_MODE=1 -DBUILD_DOC=OFF -DINSTALL_EXAMPLES=OFF"

jobs:
    # ============================================================================
    # Android Builds
    # ============================================================================
    build-android:
        name: Android (${{ matrix.arch }})
        runs-on: ubuntu-22.04
        strategy:
            fail-fast: false
            matrix:
                include:
                    - arch: arm
                      abi: armeabi-v7a
                      triple: arm-linux-androideabi
                    - arch: arm64
                      abi: arm64-v8a
                      triple: aarch64-linux-android
                    - arch: x64
                      abi: x86_64
                      triple: x86_64-linux-android
                    - arch: x86
                      abi: x86
                      triple: i686-linux-android
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Android NDK
              id: setup-ndk
              uses: nttld/setup-ndk@v1
              with:
                  ndk-version: r29

            - name: Export NDK path
              run: echo "ANDROID_NDK_LATEST_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

            - name: Clone Sources
              run: |
                  git clone --depth 1 --branch v${{ env.QPDF_VERSION }} https://github.com/qpdf/qpdf.git qpdf-src
                  git clone --depth 1 --branch ${{ env.LIBJPEG_TURBO_VERSION }} https://github.com/libjpeg-turbo/libjpeg-turbo.git libjpeg-turbo-src

            - name: Build libjpeg-turbo
              run: |
                  echo "Android NDK Root: $ANDROID_NDK_LATEST_HOME"
                  echo "CMAKE version: $(cmake --version)"
                  cd libjpeg-turbo-src
                  mkdir build && cd build
                  cmake .. \
                    -DANDROID_ABI=${{ matrix.abi }} \
                    -DANDROID_PLATFORM=android-21 \
                    -DANDROID_STL=c++_shared \
                    -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_LATEST_HOME/build/cmake/android.toolchain.cmake \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/deps-${{ matrix.abi }} \
                    -DENABLE_SHARED=ON \
                    -DENABLE_STATIC=OFF \
                    -DWITH_TURBOJPEG=OFF \
                    -DCMAKE_C_FLAGS_RELEASE="-Oz -g0 -fdata-sections -ffunction-sections" \
                    -DCMAKE_CXX_FLAGS_RELEASE="-Oz -g0 -fdata-sections -ffunction-sections" \
                    -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections" \
                    -DCMAKE_SHARED_LINKER_FLAGS="-Wl,--gc-sections" \
                    -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
                    -DCMAKE_CXX_VISIBILITY_PRESET=hidden \
                    -DCMAKE_VISIBILITY_INLINES_HIDDEN=ON
                  cmake --build . --parallel $(nproc)
                  file libjpeg.so
                  cmake --install .

            - name: Build QPDF
              run: |
                  echo "Android NDK Root: $ANDROID_NDK_LATEST_HOME"
                  echo "CMAKE version: $(cmake --version)"
                  cd qpdf-src
                  mkdir build && cd build

                  cmake .. \
                    -DANDROID_ABI=${{ matrix.abi }} \
                    -DANDROID_PLATFORM=android-21 \
                    -DANDROID_STL=c++_shared \
                    -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_LATEST_HOME/build/cmake/android.toolchain.cmake \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_FIND_ROOT_PATH="${{ github.workspace }}/deps-${{ matrix.abi }}" \
                    -DPKG_CONFIG_EXECUTABLE=NOTFOUND \
                    -DBUILD_SHARED_LIBS=ON \
                    -DBUILD_STATIC_LIBS=OFF \
                    -DCMAKE_C_FLAGS_RELEASE="-Oz -g0 -fdata-sections -ffunction-sections" \
                    -DCMAKE_CXX_FLAGS_RELEASE="-Oz -g0 -fdata-sections -ffunction-sections" \
                    -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections" \
                    -DCMAKE_SHARED_LINKER_FLAGS="-Wl,--gc-sections" \
                    -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
                    -DCMAKE_CXX_VISIBILITY_PRESET=hidden \
                    -DCMAKE_VISIBILITY_INLINES_HIDDEN=ON \
                    ${{ env.CMAKE_COMMON_FLAGS }}
                  cmake --build . --parallel $(nproc) --target libqpdf

            - name: Collect Artifacts
              run: |
                  mkdir -p artifacts/android-${{ matrix.arch }}
                  find qpdf-src/build/libqpdf -name "*.so" -exec cp {} artifacts/android-${{ matrix.arch }}/ \;
                  find ${{ github.workspace }}/deps-${{ matrix.abi }} -name "*.so" -exec cp {} artifacts/android-${{ matrix.arch }}/ \;
                  cp $ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/${{ matrix.triple }}/libc++_shared.so artifacts/android-${{ matrix.arch }}/
                  NDK_STRIP=$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip
                  $NDK_STRIP --strip-unneeded artifacts/android-${{ matrix.arch }}/libqpdf.so
                  $NDK_STRIP --strip-unneeded artifacts/android-${{ matrix.arch }}/libjpeg.so
                  $NDK_STRIP --strip-unneeded artifacts/android-${{ matrix.arch }}/libc++_shared.so
                  tar -cvhf artifacts/android-${{ matrix.arch }}.tar -C artifacts android-${{ matrix.arch }}

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: qpdf-android-${{ matrix.arch }}
                  path: artifacts/android-${{ matrix.arch }}.tar
